# Ubuntu NVIDIA Drivers HP Pavilion 14 dh0xxx x360

This repository wraps a workaround to make [Ubuntu NVIDIA drivers](https://documentation.ubuntu.com/server/how-to/graphics/install-nvidia-drivers/) work in HP Pavilion 14 dh0xxx x360 laptops. As mentioned, it's just a temporary workaround which may affect touchpad and touchscreen performances. Therefore, the provided script grants access to the NVIDIA graphics card, which can be used for specific tasks, and then safely roll back to the original non-driver system configuration. Better solutions and improvement ideas are wellcome.

It's basically a small, safe bash utility to add `acpi_osi=!` and `acpi_osi="Windows 2009"` to the `GRUB_CMDLINE_LINUX_DEFAULT` line in `/etc/default/grub` — with automatic backups and easy restore options.

> **Important:** This script modifies `/etc/default/grub` and **requires running `sudo reboot` afterwards**. Always review backups before restoring or applying changes.

---

## Features

* Adds `acpi_osi=!` and `acpi_osi="Windows 2009"` to the `GRUB_CMDLINE_LINUX_DEFAULT` line (idempotent — will not duplicate tokens).
* Creates a timestamped backup for every change: by default stored under `/var/backups/grub-acpi-osi`.
* On the first `--add` run creates an ` /etc/default/grub.orig` file (the original copy) so you can always restore the unmodified original.
* Restore any backup or the original easily via command-line options.
* Optional automatic `update-grub` invocation; can be disabled with `--no-update-grub`.

---

## Requirements

* `sudo` or root privileges to modify `/etc/default/grub` and run `update-grub`.
* `python3` — usually available on modern Debian/Ubuntu systems.

---

## Installation

Save the script to a file:

```bash
sudo cp grub-update-reboot.sh /usr/local/sbin/grub-update-reboot.sh
sudo chmod +x /usr/local/sbin/grub-update-reboot.sh
```

---

## Usage

Run the script with `sudo`.

```
sudo grub-update-reboot.sh --add [--no-update-grub] [--backup-dir DIR]
sudo grub-update-reboot.sh --restore
sudo grub-update-reboot.sh --restore-file /path/to/backup
sudo grub-update-reboot.sh --help
```

### Command-line options

* `--add` — Add the ACPI options to `GRUB_CMDLINE_LINUX_DEFAULT`. Creates a timestamped backup in the backup directory before modifying. On the very first `--add` run, the original `/etc/default/grub` is also copied to `/etc/default/grub.orig`.

* `--restore` — Restore the original file saved at `/etc/default/grub.orig` (if present). The script will create a pre-restore backup of the current `/etc/default/grub` before overwriting.

* `--restore-file PATH` — Restore a specific backup file (`PATH` should point to a file previously generated by the script).

* `--no-update-grub` — Do not automatically run `update-grub` after making changes or restoring. If omitted, the script will attempt to run `update-grub` if it exists.

* `--backup-dir DIR` — Store backups under `DIR`. Defaults to `/var/backups/grub-acpi-osi`.

* `-h, --help` — Show help text.

---

## Examples

* Add the options and run `update-grub` automatically:

```bash
sudo ./grub-update-reboot.sh --add
```

* Add the options but skip running `update-grub` (you will run it manually later):

```bash
sudo ./grub-update-reboot.sh --add --no-update-grub
```

* Restore the original file created on the first run:

```bash
sudo ./grub-update-reboot.sh --restore
```

* Restore from a specific backup file:

```bash
sudo ./grub-update-reboot.sh --restore-file /var/backups/grub-acpi-osi/grub.20250824093000
```

---

## Backups

* Each change creates a timestamped backup named `grub.<timestamp>` under the backup directory (default: `/var/backups/grub-acpi-osi`).
* The script keeps the very first original file as `/etc/default/grub.orig` for easy full restore.
* When restoring, the script also creates a timestamped backup of the current `/etc/default/grub` before overwriting it.

---

## Safety

* The script attempts to be conservative: it only edits the first non-commented `GRUB_CMDLINE_LINUX_DEFAULT` line it finds.
* It is idempotent: running `--add` multiple times will not duplicate the tokens.
* Always inspect backups before restoring if you want to confirm the exact previous contents.

---

## Troubleshooting

* If `update-grub` is not found, the script will skip running it and display a message. On Debian/Ubuntu you can run it manually as:

```bash
sudo update-grub
```

* If the script could not find a `GRUB_CMDLINE_LINUX_DEFAULT` line, it will append a new section to the end of the file with the expected setting. Inspect the file before rebooting.

---

## References

* https://bugs.launchpad.net/ubuntu/+source/linux/+bug/1742112
* https://forums.linuxmint.com/viewtopic.php?t=364639
* https://forum.proxmox.com/threads/amd-gpu-inaccessible-after-vm-poweroff-unable-to-change-power-state-from-d3cold-to-d0-device-inaccessible.130975/

---

## License

This repository is provided as-is under the MIT license. See [`LICENSE`](./LICENSE) for details.

